name: CI

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Set git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref || 'main' }}

      - uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'main'
          workflow-id: 'ci.yml'

      - name: Set NX_BASE and NX_HEAD fallbacks
        run: |
          if [ -z "${NX_BASE}" ]; then
            echo "NX_BASE=origin/${{ github.base_ref || 'main' }}" >> $GITHUB_ENV
          fi
          if [ -z "${NX_HEAD}" ]; then
            echo "NX_HEAD=${{ github.sha }}" >> $GITHUB_ENV
          fi
        # NX_BASE and NX_HEAD persist for the whole job; both distributed lint/test/build and e2e use the same affected graph

      - name: Run lint, test, build (distributed via Nx Cloud agents)
        run: |
          npx nx-cloud start-ci-run \
            --distribute-on=".nx/workflows/distribution-config.yaml" \
            --stop-agents-after=lint,test,build \
            --stop-agents-on-failure \
            -- pnpm nx affected -t lint test build

      - name: Wait for Vercel Preview URLs
        if: github.event_name == 'pull_request' && vars.VERCEL_PREVIEW_ENABLED == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ vars.VERCEL_TEAM_ID }}
          VERCEL_PROJECT_ID_LANDING_PAGE: ${{ vars.VERCEL_PROJECT_ID_LANDING_PAGE }}
          VERCEL_PROJECT_ID_JOE_BOT: ${{ vars.VERCEL_PROJECT_ID_JOE_BOT }}
          VERCEL_PROJECT_ID_TODO_APP: ${{ vars.VERCEL_PROJECT_ID_TODO_APP }}
          GIT_REF: ${{ github.head_ref || github.ref_name }}
        run: . ./.github/scripts/wait-for-vercel-preview-urls.sh

      # E2E runs on coordinator only (needs BASE_URL_* from Vercel wait for preview deployments)
      # Use e2e-preview (uncacheable) when Vercel preview URLs vary per PR; use e2e (cacheable) otherwise
      - name: Run E2E tests
        run: |
          if [ "${VERCEL_PREVIEW_ENABLED:-false}" = 'true' ]; then
            pnpm nx affected -t e2e-preview
          else
            pnpm nx affected -t e2e
          fi
        env:
          VERCEL_PREVIEW_ENABLED: ${{ vars.VERCEL_PREVIEW_ENABLED }}

      - run: pnpm nx fix-ci
        if: always()
